<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEGWIN Game Admin</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; text-align: center; padding: 20px; }
        h1 { margin-bottom: 20px; color: #0f0; text-shadow: 0 0 10px #0f0; }
        .panel { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
        
        input[type="text"] { width: 70%; padding: 10px; font-size: 16px; border-radius: 5px; border: none; }
        button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 5px; }
        button:active { transform: scale(0.95); }

        .btn-save { background: #007bff; color: white; }
        .btn-toggle { width: 100%; font-size: 24px; padding: 20px; margin-top: 10px; }
        .btn-on { background: #dc3545; color: white; box-shadow: 0 0 15px red; } /* STOPãƒœã‚¿ãƒ³ */
        .btn-off { background: #28a745; color: white; box-shadow: 0 0 15px green; } /* STARTãƒœã‚¿ãƒ³ */

        .btn-damage { background: #ff9999; color: #500; }
        .btn-heal { background: #99ff99; color: #050; }
        
        #current-id { font-weight: bold; color: #ffff00; font-size: 1.2em; }
    </style>
</head>
<body>

    <h1>ğŸ® MEGWIN LIVE CONTROL</h1>

    <div class="panel">
        <h2>ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¤ãƒƒãƒ (APIç¯€ç´„)</h2>
        <div id="status-display">èª­ã¿è¾¼ã¿ä¸­...</div>
        <button id="toggle-btn" class="btn-toggle" onclick="toggleSystem()">---</button>
        <p><small>STOPä¸­ã¯æ‰‹å…ƒã®PythonãŒå¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã€é€šä¿¡é‡ã‚’ç¯€ç´„ã—ã¾ã™ã€‚</small></p>
    </div>

    <div class="panel">
        <h2>YouTube Video ID</h2>
        <p>ç¾åœ¨ã®ID: <span id="current-id">---</span></p>
        <input type="text" id="video-id-input" placeholder="URLã¾ãŸã¯IDã‚’å…¥åŠ› (ä¾‹: https://youtube.com/live/...)" />
        <button class="btn-save" onclick="saveVideoID()">è¨­å®šä¿å­˜</button>
        <p><small>URLã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ã‚‚è‡ªå‹•ã§IDã ã‘æŠ½å‡ºã—ã¾ã™ï¼</small></p>
    </div>

    <div class="panel">
        <h2>å‹•ä½œãƒ†ã‚¹ãƒˆ</h2>
        <button class="btn-damage" onclick="sendAction('damage', 500)">ğŸ‘¿ ã‚¢ãƒ³ãƒ (+500)</button>
        <button class="btn-damage" onclick="sendAction('damage', 2000)">ğŸ‘¿ å¼¾å¹• (+2000)</button>
        <br>
        <button class="btn-heal" onclick="sendAction('heal', 500)">ğŸ˜‡ å¿œæ´ (-500)</button>
        <button class="btn-heal" onclick="sendAction('heal', 10000)">ğŸ’° èµ¤ã‚¹ãƒ‘ (-10000)</button>
    </div>

    <script>
        const API_STATUS = '/api/status';
        const API_TOGGLE = '/api/toggle';
        const API_CONFIG = '/api/config_video';
        const API_ACTION = '/api/action';

        const statusDisplay = document.getElementById('status-display');
        const toggleBtn = document.getElementById('toggle-btn');
        const currentIdSpan = document.getElementById('current-id');
        const videoIdInput = document.getElementById('video-id-input');

        // çŠ¶æ…‹ã®æ›´æ–°
        function updateUI(state) {
            currentIdSpan.innerText = state.video_id || "(æœªè¨­å®š)";
            
            if (state.is_active) {
                statusDisplay.innerText = "ç¾åœ¨ã®çŠ¶æ…‹: â— ç¨¼åƒä¸­ (ONLINE)";
                statusDisplay.style.color = "#0f0";
                toggleBtn.innerText = "ğŸ›‘ ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã™ã‚‹";
                toggleBtn.className = "btn-toggle btn-on";
            } else {
                statusDisplay.innerText = "ç¾åœ¨ã®çŠ¶æ…‹: â¸ åœæ­¢ä¸­ (PAUSED)";
                statusDisplay.style.color = "yellow";
                toggleBtn.innerText = "â–¶ ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹";
                toggleBtn.className = "btn-toggle btn-off";
            }
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        fetch(API_STATUS).then(r => r.json()).then(updateUI);

        // ã‚¹ã‚¤ãƒƒãƒåˆ‡æ›¿
        function toggleSystem() {
            fetch(API_TOGGLE, { method: 'POST' }).then(r => r.json()).then(updateUI);
        }

        // â˜…ã“ã“ãŒæ–°æ©Ÿèƒ½ï¼URLã‹ã‚‰IDã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractVideoId(input) {
            input = input.trim();
            // URLã˜ã‚ƒãªã„(ãŸã ã®ID)ãªã‚‰ãã®ã¾ã¾è¿”ã™
            if (!input.includes("http") && !input.includes("youtube") && !input.includes("youtu.be")) {
                return input;
            }

            let videoId = "";
            try {
                // ãƒ‘ã‚¿ãƒ¼ãƒ³1: https://youtube.com/live/xxxx?feature...
                if (input.includes("/live/")) {
                    videoId = input.split("/live/")[1];
                }
                // ãƒ‘ã‚¿ãƒ¼ãƒ³2: https://youtu.be/xxxx
                else if (input.includes("youtu.be/")) {
                    videoId = input.split("youtu.be/")[1];
                }
                // ãƒ‘ã‚¿ãƒ¼ãƒ³3: https://www.youtube.com/watch?v=xxxx
                else if (input.includes("v=")) {
                    videoId = input.split("v=")[1];
                }
                
                // å¾Œã‚ã«ã¤ã„ãŸ ?feature=share ãªã©ã‚’ã‚«ãƒƒãƒˆã™ã‚‹
                if (videoId) {
                    const ampersandPos = videoId.indexOf('&');
                    const questionPos = videoId.indexOf('?');
                    if (ampersandPos !== -1) videoId = videoId.substring(0, ampersandPos);
                    if (questionPos !== -1) videoId = videoId.substring(0, questionPos);
                    return videoId;
                }
            } catch (e) {
                console.error("IDæŠ½å‡ºã‚¨ãƒ©ãƒ¼", e);
            }
            return input; // ä¸‡ãŒä¸€å¤±æ•—ã—ãŸã‚‰ãã®ã¾ã¾è¿”ã™
        }

        // ãƒ“ãƒ‡ã‚ªIDä¿å­˜ï¼ˆæŠ½å‡ºæ©Ÿèƒ½ä»˜ãï¼‰
        function saveVideoID() {
            const rawInput = videoIdInput.value;
            const vid = extractVideoId(rawInput); // è‡ªå‹•æŠ½å‡ºï¼

            if (!vid) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            // ç¢ºèªç”¨ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆã†ã–ã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰
            // alert("è¨­å®šã™ã‚‹ID: " + vid);

            fetch(API_CONFIG, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_id: vid })
            }).then(r => r.json()).then(data => {
                alert("ä¿å­˜ã—ã¾ã—ãŸï¼\nè¨­å®šID: " + vid);
                updateUI(data);
                videoIdInput.value = "";
            });
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
        function sendAction(type, amount) {
            fetch(API_ACTION, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, amount: amount })
            });
        }
    </script>
</body>
</html>
